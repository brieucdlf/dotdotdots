# https://system76.com/time
# avoid the ntp protocol and replace it with sntp
# Got to ask System76 if they will bring us EU servers
# This is temp since it will be implemented by default on Pop!_OS
- name: system setup | clock | install chrony
  tags: ntp, sntp, system setup
  package:
    name: chrony
    state: latest
  when: ansible_distribution in ["Pop!_OS"]

- name: "system setup | clock | update chrony conf"
  become: yes
  become_user: root
  tags: ntp, sntp, system, setup
  lineinfile:
    path: /etc/chrony/chrony.conf
    line: '# \1'
    regexp: "{{ item.regexp }}"
    backrefs: yes
    state: present
  loop:
    - { regexp: "(^pool.*)", line: '# \1' }
    - { regexp: "(^pool.*)", line: '# \1' }
    - { regexp: "(^pool.*)", line: '# \1' }
    - { regexp: "(^pool.*)", line: '# \1' }
  register: commentDone

- name: "system setup | clock | add system76 conf"
  become: yes
  become_user: root
  tags: ntp, sntp, system, setup
  lineinfile:
    path: /etc/chrony/chrony.conf
    insertafter: "{{ item.insertafter }}"
    line: "{{ item.line }}"
    state: present
  loop:
    - {
        insertafter: "# See http://www.pool.ntp.org/join.html for more information.",
        line: "server virginia.time.system76.com iburst nts",
      }
    - {
        insertafter: "# See http://www.pool.ntp.org/join.html for more information.",
        line: "server ohio.time.system76.com iburst nts",
      }
    - {
        insertafter: "# See http://www.pool.ntp.org/join.html for more information.",
        line: "server oregon.time.system76.com iburst nts",
      }
  register: system76UpdateDone

- name: system setup | clock | restart service chrony
  systemd:
    name: chrony
    state: restarted

- name: system setup | clock | set time zone
  tags: ntp, sntp, timezone, system setup
  timezone:
    name: "Europe/Paris"
